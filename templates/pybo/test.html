{% extends 'base.html' %}

{% block content %}
<style>
/*드롭존 스타일 설정*/
    /*드롭존 컨테이너 */
    .drop-zone-container {
    display: flex; /* 컨테이너 나란히 배치하기 위해서 flex사용 */
    justify-content: space-between; /* 사이 공간을 균등하게 사용 */
    gap: 20px; /* 드롭존 사이에 간격 추가 */
    margin-bottom: 20px; /* 드롭존 아래 여백 추가 */
    }
    /*드롭존 */
    .drop-zone {
    border: 2px dashed #007bff; /*테두리 설정, 두께, 스타일, 색상*/
    padding: 10px; /*내부 여백*/
    text-align: center;
    height: 150px;
    width: 48%; /* Adjust width */
    background-color: #f8f9fa; /*배경 연한 회색*/
    border-radius: 0.25rem; /*모서리 둥글게 정도*/
    position: relative; /* 자식 요소의 절대 위치 설정을 위한 상대 위치 지정 */
    overflow: hidden; /* 자식 요소가 부모 요소의 경계를 넘지 않도록 설정 */
    }
    /*드롭존 호버 일때*/
    .drop-zone.hover {
    background-color: #e9ecef;
    }
    /*드롭존 텍스트*/
    .drop-zone .drop-text {
    text-align: center;
    z-index: 10;
    color: black;
    }
    /*드롭존에 보여줄 이미지 설정*/
    .drop-zone img {
    max-width: 100%;
    max-height: 100%;
    display: none; /* Default to hidden */
    }

    /* 드롭존에 input 파일 영역 */
    .file-input {
    opacity: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    }

/* 팝업 스타일 */
    .modal {
        display: none; /*일단 비활성화*/
        position: fixed; /*화면을 움직여도 고정*/
        z-index: 1; /*팝업이 다른것들보다 위에 표시되도록*/
        left: 0; /*왼쪽 끝*/
        top: 0; /*최상단*/
        width: 100%;    /*가로크기*/
        height: 100%;   /*세로 크기*/
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center; /* 모달의 콘텐츠를 세로 방향으로 중앙에 정렬합니다. */

    }
    /*팝업창 내용*/
    .modal-content {
    background-color: black; /*팝업창 바탕색*/
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 600px; /* 화면 너비 */
    position: relative;
    box-sizing: border-box;
    color: white; /* Set text color to white */
    }
    /*확인 버튼*/
    .confirm-btn {
    cursor: pointer;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-size: 16px;
    display: block;
    margin: 20px auto 0; /* 확인 버튼의 마진을 넣어서 */
    }


    /* 비활성화된 버튼 스타일 */
    .btn[disabled] {
        background-color: #ccc;
        cursor: not-allowed;
    }


/* 이미지 미리 보기 스타일 설정 */
    .image-preview-row {
    display: flex;
    align-items: center;
    gap: 20px; /* 이미지와 텍스트 간의 간격 */
    }
    /*이미지 미리보기 컨테이너 설정*/
    .image-preview-container {
    text-align: center;
    }
    /*이미지 미리보기 설정*/
    .image-preview {
    max-width: 150px; /* 이미지 크기 조정 */
    max-height: 150px;
    margin-bottom: 10px; /* 이미지와 텍스트 간의 간격 */
    }
</style>

<!-- 이미지 등록 팝업창  -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2>이미지 업로드</h2>

        <!--drop-zone-container-->
        <div class="drop-zone-container">
            <!-- 첫 번째 이미지 드래그 앤 드롭 -->
            <div id="drop-zone1" class="drop-zone">
                <div class="drop-text"> image 1 drop or clik.</div>
                <input type="file" id="image1" class="file-input" accept="image/*">
                <img id="preview-image1" />
            </div>

            <!-- 두 번째 이미지 드래그 앤 드롭 -->
            <div id="drop-zone2" class="drop-zone">
                <div class="drop-text">image 2 drop or clik.</div>
                <input type="file" id="image2" class="file-input" accept="image/*">
                <img id="preview-image2" />
            </div>
        </div>
        <!-- 확인 버튼 -->
        <button class="confirm-btn">확인</button>
    </div>
</div>

<div class="container">
    <form id="questionForm" method="post" class="post-form my-3" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
                {% for field in form %}
                    {% if field.errors %}
                        <strong>{{ field.label }}</strong>
                        {{ field.errors }}
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}

        <!--제목-->
        <div class="form-group">
            <label for="subject">제목</label>
            <input type="text" name="subject" id="subject" class="form-control" value="{{ form.subject.value|default_if_none:'' }}">
        </div>

        <!--내용-->
        <div class="form-group">
            <label for="content">내용</label>
            <textarea name="content" id="content" class="form-control" rows="10">{{ form.content.value|default_if_none:'' }}</textarea>
        </div>

        <!-- 업로드 팝업 버튼 설정: if면 수정일때, else면 등록일때 -->
        <button type="button" id="uploadBtn" class="btn btn-secondary mt-3">
            {% if form.instance.pk %}
            이미지 새로 등록 및 확인
            {% else %}
            이미지 등록 및 보기
            {% endif %}
        </button>

<!-- 이미지 업로드 후 메인 화면에 미리보기 표시 -->
<div id="image-preview-container" class="my-3">
    <div class="image-preview-row">
        <div id="main-preview1" class="image-preview-container">
            {% if form.instance.image1 %}
                <p>등록된 이미지 1</p>
                <img src="{{ form.instance.image1.url }}" alt="Uploaded Image 1" class="image-preview" id="image-preview1">

            {% endif %}
        </div>
        <div id="main-preview2" class="image-preview-container">
            {% if form.instance.image2 %}
            <p>등록된 이미지 2</p>
                <img src="{{ form.instance.image2.url }}" alt="Uploaded Image 2" class="image-preview" id="image-preview2">

            {% endif %}
        </div>
    </div>
</div>
        <!--   수정을 눌렀을때는 수정하기 질문등록을 눌렀을때는 등록하기     -->
        <button type="submit" class="btn btn-primary mt-3">
            {% if form.instance.pk %}
                수정하기
            {% else %}
                등록하기
            {% endif %}
        </button>
    </form>
</div>


{% endblock %}


{% block script %}
<script>
$(document).ready(function() {
    //팝업창 구현을 팝업창, 이미지 등록 버튼,확인 버튼 기능
    const modal = $('#uploadModal');
    const uploadBtn = $('#uploadBtn');
    const confirmBtn = $('.confirm-btn');

    //제목과 내용을 입력 확인을 위한
    const subjectInput = $('#subject');
    const contentInput = $('#content');

    //미리 보기를 위한 questionForm 전송
    const questionForm = $('#questionForm');
    const imagePreviewContainer = $('#image-preview-container');

    //팝업창 이미지 업로드를 위한 셋팅
    const imageUploadSettings = [
        { input: '#image1', dropZone: '#drop-zone1', previewId: '#preview-image1', mainPreviewId: '#main-preview1 img' },
        { input: '#image2', dropZone: '#drop-zone2', previewId: '#preview-image2', mainPreviewId: '#main-preview2 img' }
    ];
    //이미지로드셋팅 기능에 넣을 것 : 드로그앤드롭,파일넣기,드롭박스에 글, 이미지 미리보기
    function setupImageUpload(inputSelector, dropZoneSelector, previewId) {
        const $dropZone = $(dropZoneSelector);
        const $fileInput = $(inputSelector);
        const $dropText = $dropZone.find('.drop-text');
        const $imagePreview = $(previewId);

//드롭존 설정
        //dragover은 드래그하면서 마우스가 대상 객체의 위에 자리 잡고 있을 때 발생함.
        $dropZone.on('dragover', function(event) {
            event.preventDefault();
            $dropZone.addClass('hover');
        });

        //dragleave 드래그가 끝나서 마우스가 대상 객체의 위에서 벗어날 때 발생함.
        $dropZone.on('dragleave', function() {
            $dropZone.removeClass('hover');
        });
        // drop 드래그가 끝나서 드래그하던 객체를 놓는 장소에 위치한 객체에서 발생함.
        $dropZone.on('drop', function(event) {
        // 기본 동작을 방지하여 드롭이 브라우저의 기본 동작을 방해하지 않도록 함
        event.preventDefault();

        // 드래그가 끝나면서 드롭존의 'hover' 클래스를 제거하여 스타일을 원래대로 돌림
        $dropZone.removeClass('hover');

        // 드롭 이벤트에서 파일 정보를 가져옴
        const files = event.originalEvent.dataTransfer.files;

        // 파일이 있고 파일의 타입이 이미지인지 확인
        if (files.length > 0 && files[0].type.startsWith('image/')) {
        // 파일 입력 요소에 드롭된 파일을 할당
        $fileInput[0].files = files;

        // 드롭존에 표시된 텍스트를 숨김
        $dropText.hide();

        // FileReader 객체를 생성하여 파일을 읽음
        const reader = new FileReader();

        // 파일 읽기가 완료된 후 호출되는 이벤트 핸들러
        //e.target.result는 FileReader가 파일을 읽은 결과를 포함
        reader.onload = function(e) {

        //e.target.result을 미리보기를 할 수있도록 변환하고 이를 보여줌
        $imagePreview.attr('src', e.target.result).show();
        }
        // 파일을 데이터 URL로 읽기 시작
        reader.readAsDataURL(files[0]);
    }
});
        //드래그존을 클릭했을 때, fileinput 클릭
        $dropZone.on('click', function() {
            $fileInput.click();
        });
        //fileinput이 바뀔 때 드래그존과 비슷함
        $fileInput.on('change', function(event) { //파일이 변경될 때 function(event)호출
            if (event.target.files.length > 0) {
                $dropText.hide(); //안내 문구 숨김
                const reader = new FileReader();
                reader.onload = function(e) {
                    $imagePreview.attr('src', e.target.result).show();
                }
                reader.readAsDataURL(event.target.files[0]);
            }
        });
    }
    // subjectInput,contentInput이 공백인지 확인후 공백이면 업로드 버튼 비활성화
    function checkFormValidity() {
        const subjectValid = subjectInput.val().trim() !== '';
        const contentValid = contentInput.val().trim() !== '';
        uploadBtn.prop('disabled', !(subjectValid && contentValid));
    }
    //업로드 버튼을 클릭하면 팝업창 보이기,
    uploadBtn.on('click', function() {
        modal.css('display', 'flex');
    });
    //확인 버튼을 누르면 팝업 숨기기
    confirmBtn.on('click', function() {
        modal.hide();

        //  imageUploadSettings를 각각 input,previewId,mainPreviewId 아이디를 부여 230
        imageUploadSettings.forEach(setting => {
            const fileInput = $(setting.input)[0];
            const previewImg = $(setting.previewId);
            const mainPreviewImg = $(setting.mainPreviewId);

            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.attr('src', e.target.result).show();
                    mainPreviewImg.attr('src', e.target.result).show();
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                // 파일이 없을 때 기존 이미지 유지(id확인, mainPreviewImg를 통한 기존이미지 보여주기)
                const existingImgSrc = mainPreviewImg.attr('src');
                if (existingImgSrc) {
                    previewImg.attr('src', existingImgSrc).show();
                }
            }
        });
    });

    imageUploadSettings.forEach(setting => {
        setupImageUpload(setting.input, setting.dropZone, setting.previewId);
    });
    //input이 되면 ckeckFormValidity 작동
    subjectInput.add(contentInput).on('input', checkFormValidity);
    checkFormValidity();

    // 폼 제출 처리 막기
    questionForm.on('submit', function(event) {
        event.preventDefault();
        //현재 폼 참조
        const formData = new FormData(this);

        // 앞에서 imageUploadSettings를 각각 처리 fileInput
        imageUploadSettings.forEach(setting => {
            const fileInput = $(setting.input)[0];
            //formData에 이미지 파일을 더함
            if (fileInput.files.length > 0) {
                formData.append(fileInput.id, fileInput.files[0]); // image1, image2 추가
            }
        });
        //폼이 수정되었는지 아닌지 묻는중
        const isModify = '{{ form.instance.pk|yesno:"true,false" }}';
        //만약 폼이 새로 생성되는 것이 아니라 수정하는 경우에만 pk 값이 설정되며, 그렇지 않으면 questionId는 빈 문자열이 됩니다.
        const questionId = '{{ form.instance.pk }}';
        //isModify가 'true'인 경우 (즉, 수정 모드인 경우), 수정 URL이 설정
        //삼항 연산자 (조건식?참일때실행:거짓일때 수행)
        const url = isModify === 'true'
            ? '{% url "pybo:question_modify" question_id=0 %}'.replace('0', questionId)
            //isModify가 'false'인 경우 (즉, 생성 모드인 경우), 생성 URL이 설정
            : '{% url "pybo:question_create" %}';

    $.ajax({
            url: url, //위에서 설정된 url
            method: 'POST', //HTTP 메서드 지정
            data: formData, // 서버에 보낼 데이터 *from
            processData: false, // 데이터 자동 처리인데 form을 사용하기때문에 false
            contentType: false, // 위와 마찬가지로 기본적으로 multipart/form-data
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                window.location.href = response.redirect_url; //성공했을때 redirect_url을 가져와 페이지 redirect
            },
            error: function() {
                alert('저장에 실패했습니다. 다시 시도해 주세요.');
            }
        });
    });
});
</script>
{% endblock %}
